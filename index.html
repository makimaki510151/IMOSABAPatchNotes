<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>芋鯖パッチノート</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        nav { display: flex; background: #007bff; }
        nav button { flex: 1; padding: 15px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; font-size: 1rem; }
        nav button.active { background: #004a99; border-bottom: 4px solid #fff; }
        nav button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* ローディングオーバーレイ */
        #loading-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #007bff;
        }

        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        section { margin-bottom: 25px; }
        h3 { border-left: 5px solid #007bff; padding-left: 10px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-size: 0.85rem; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        
        button { cursor: pointer; transition: opacity 0.2s; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        button.primary { width: 100%; margin-top: 20px; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 1rem; }
        
        .filter-area { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .patch-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #fff; }
        .patch-card.pending { border-left: 5px solid #ffc107; background: #fffdf5; }
        .patch-card.confirmed { border-left: 5px solid #28a745; }
        .date { font-size: 0.75rem; color: #999; margin-bottom: 5px; }
        .user-tag { font-weight: bold; color: #007bff; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #ffc107; color: #000; margin-left: 8px; }
        .action-btns { margin-top: 10px; display: flex; gap: 10px; }
        .confirm-btn { padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 0.8rem; }
        .delete-btn { padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading-overlay">通信中...</div>
    
    <nav id="main-nav">
        <button id="tab-post" class="active" onclick="showPage('post')">設定・投稿</button>
        <button id="tab-history" onclick="showPage('history')">パッチ履歴</button>
    </nav>

    <div id="page-post" class="page active">
        <section>
            <h3>ユーザー設定</h3>
            <label>ログイン中：</label>
            <select id="userList"></select>
            <div style="display: flex; gap: 5px; margin-top:10px;">
                <input type="text" id="newUserName" placeholder="新しい名前を追加">
                <button onclick="addUser()" class="api-btn">登録</button>
            </div>
        </section>

        <section>
            <h3>パッチ投稿</h3>
            <label>対象ユーザー</label>
            <select id="targetUserList"></select>
            <label>日付</label>
            <input type="date" id="patchDate">
            <label>内容</label>
            <textarea id="patchContent" rows="4"></textarea>
            <button class="primary api-btn" onclick="addPatch()">投稿する</button>
        </section>
    </div>

    <div id="page-history" class="page">
        <div class="filter-area">
            <label>ユーザー絞り込み：</label>
            <select id="filterUser" onchange="renderPatches()">
                <option value="all">全員分を表示</option>
            </select>
        </div>
        <div id="patchDisplay"></div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxnwn-bkEL1SG1nfx2fzRG-Xj4QMjmkHhcZYv2EZZ4xFt5pprURDXtL6DMkLxQ-DQjl/exec';
    let allPatches = [];
    let currentUser = "";
    let isLoading = false;

    // 通信状態の切り替え
    function setLoading(state) {
        isLoading = state;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = state ? 'flex' : 'none';
        
        // 全てのボタンとセレクトボックスを無効化
        const inputs = document.querySelectorAll('button, input, select, textarea');
        inputs.forEach(el => el.disabled = state);
    }

    function showPage(pageId) {
        if (isLoading) return; // ロード中は切り替え不可
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        document.getElementById(`tab-${pageId}`).classList.add('active');
        if (pageId === 'history') fetchData();
    }

    async function fetchData() {
        setLoading(true);
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            allPatches = data.patches;
            updateUserLists(data.users);
            renderPatches();
        } catch (e) {
            alert("データの取得に失敗しました");
        } finally {
            setLoading(false);
        }
    }

    function updateUserLists(users) {
        const userSelect = document.getElementById('userList');
        const targetSelect = document.getElementById('targetUserList');
        const filterSelect = document.getElementById('filterUser');
        const options = users.map(u => `<option value="${u}">${u}</option>`).join('');
        
        if (!userSelect.innerHTML) {
            userSelect.innerHTML = options;
            if(users.length > 0) currentUser = users[0];
        }
        targetSelect.innerHTML = options;
        const currentFilter = filterSelect.value;
        filterSelect.innerHTML = '<option value="all">全員分を表示</option>' + options;
        filterSelect.value = currentFilter || "all";
    }

    function renderPatches() {
        const display = document.getElementById('patchDisplay');
        const filter = document.getElementById('filterUser').value;
        
        const visiblePatches = allPatches.filter(p => {
            return p.status === 'confirmed' || (p.status === 'pending' && p.userName === currentUser);
        });

        const sorted = visiblePatches.sort((a, b) => new Date(b.date) - new Date(a.date));
        const filtered = filter === 'all' ? sorted : sorted.filter(p => p.userName === filter);

        if (filtered.length === 0) {
            display.innerHTML = '<p style="text-align:center; color:#999;">表示できるパッチはありません</p>';
            return;
        }

        display.innerHTML = filtered.map(p => `
            <div class="patch-card ${p.status === 'pending' ? 'pending' : 'confirmed'}">
                <div class="date">${new Date(p.date).toLocaleDateString()}</div>
                <div><span class="user-tag">${p.userName}</span>: ${p.content}
                    ${p.status === 'pending' ? '<span class="status-badge">未確定（あなた宛）</span>' : ''}
                </div>
                ${p.status === 'pending' && p.userName === currentUser ? `
                    <div class="action-btns">
                        <button class="confirm-btn" onclick="handlePatch('${p.id}', 'confirmPatch')">確定する</button>
                        <button class="delete-btn" onclick="handlePatch('${p.id}', 'deletePatch')">削除する</button>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    async function handlePatch(patchId, action) {
        const msg = action === 'deletePatch' ? "このパッチを削除しますか？" : "このパッチを確定しますか？";
        if (!confirm(msg)) return;
        
        setLoading(true);
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action, patchId })
        });
        await fetchData();
    }

    async function addUser() {
        const userName = document.getElementById('newUserName').value;
        if (!userName) return;
        setLoading(true);
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addUser', userName }) });
        currentUser = userName;
        document.getElementById('newUserName').value = "";
        await fetchData();
    }

    async function addPatch() {
        const targetUser = document.getElementById('targetUserList').value;
        const date = document.getElementById('patchDate').value;
        const content = document.getElementById('patchContent').value;
        currentUser = document.getElementById('userList').value;

        if (!date || !content) return alert("入力が不足しています");

        setLoading(true);
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'addPatch', targetUser, date, content, currentUser })
        });
        document.getElementById('patchContent').value = "";
        showPage('history');
    }

    document.getElementById('patchDate').valueAsDate = new Date();
    fetchData();
    document.getElementById('userList').onchange = (e) => {
        currentUser = e.target.value;
        renderPatches();
    };
</script>

</body>
</html>